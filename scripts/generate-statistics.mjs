#!/usr/bin/env node
import { mkdir, writeFile } from 'node:fs/promises';
import path from 'node:path';

const DEFAULT_API_URL = 'https://core-api.dev.smartbuoy.eu/statistics';
const DEFAULT_API_KEY = '2d29a429-7337-4777-867e-ecdd6808025d';

const buildStatisticsUrl = (baseUrl, apiKey) => {
  try {
    const url = new URL(baseUrl);

    if (apiKey && !url.searchParams.has('apiKey')) {
      url.searchParams.set('apiKey', apiKey);
    }

    return url.toString();
  } catch (error) {
    console.error('[statistics] Invalid statistics API url', error);
    return baseUrl;
  }
};

const validateStatistics = (data) =>
  typeof data?.numberOfBookings === 'number' &&
  typeof data?.numberOfBuoys === 'number' &&
  typeof data?.numberOfDevices === 'number';

const fetchStatistics = async () => {
  const apiUrl = process.env.STATISTICS_API_URL ?? DEFAULT_API_URL;
  const apiKey = process.env.STATISTICS_API_KEY ?? DEFAULT_API_KEY;

  const requestUrl = buildStatisticsUrl(apiUrl, apiKey);

  try {
    const response = await fetch(requestUrl, {
      headers: {
        Accept: 'application/json',
      },
      cache: 'no-store',
    });

    if (!response.ok) {
      throw new Error(`${response.status} ${response.statusText}`);
    }

    const data = await response.json();

    if (!validateStatistics(data)) {
      throw new Error('Received malformed statistics payload');
    }

    return { statistics: data, fetchedAt: new Date().toISOString() };
  } catch (error) {
    console.warn('[statistics] Falling back to empty statistics due to error:', error?.message ?? error);
    return { statistics: null, fetchedAt: new Date().toISOString() };
  }
};

const writeStatisticsModule = async (payload) => {
  const outputDir = path.join(process.cwd(), 'src', 'generated');
  const outputFile = path.join(outputDir, 'statistics.ts');

  await mkdir(outputDir, { recursive: true });

  const fileContents = `// This file is auto-generated by scripts/generate-statistics.mjs\n` +
    `export const statisticsPayload = ${JSON.stringify(payload, null, 2)} as const;\n`;

  await writeFile(outputFile, fileContents, 'utf8');

  console.log('[statistics] Static statistics written to', path.relative(process.cwd(), outputFile));
};

const main = async () => {
  const payload = await fetchStatistics();
  await writeStatisticsModule(payload);
};

main().catch((error) => {
  console.error('[statistics] Failed to generate static statistics module', error);
  process.exitCode = 1;
});
