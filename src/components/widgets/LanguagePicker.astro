---
import { defaultLang, languages } from '../../i18n/ui';
import { getLangFromUrl, useTranslatedPath, getRouteWithoutLang } from '../../i18n/utils';
import { Icon } from 'astro-icon/components';
import { fetchPosts } from '~/utils/blog';

const lang = getLangFromUrl(Astro.url);
const translatePath = useTranslatedPath(lang);
const routeWithoutLang = getRouteWithoutLang(Astro.url, lang);

// Normalized path (no leading slash) to match against post permalinks
const currentPathNormalized = Astro.url.pathname.replace(/^\/+/, '');
const allPosts = await fetchPosts();
const currentPost = allPosts.find((p) => p.permalink === currentPathNormalized);

const languageLinks: { targetLang: string; label: string; href: string }[] = [];
for (const [targetLang, label] of Object.entries(languages)) {
  let href: string;

  if (currentPost) {
    // On a blog post: link to the same post in target language (by translationId) or blog index
    const translatedPost =
      currentPost.translationId &&
      allPosts.find(
        (p) => p.lang === targetLang && p.translationId === currentPost.translationId
      );
    href = translatedPost ? `/${translatedPost.permalink}` : translatePath('/blog', targetLang);
  } else {
    // Static page: use translated slugs (e.g. contact -> kontakt)
    href =
      !routeWithoutLang && defaultLang === targetLang ? '/' : translatePath(routeWithoutLang, targetLang);
  }

  languageLinks.push({ targetLang, label, href });
}
---

<ul>
  <li class="dropdown relative">
    <button
      type="button"
      class="hover:text-link dark:hover:text-white px-4 py-3 flex items-center whitespace-nowrap text-xl md:text-[0.9375rem] font-medium"
    >
      {lang.toUpperCase()}
      <Icon name="tabler:chevron-down" class="w-3.5 h-3.5 ml-0.5 rtl:ml-0 rtl:mr-0.5" />
    </button>
    <ul
      class="dropdown-menu aw-lang-dropdown hidden absolute right-0 bottom-full mb-1 rounded drop-shadow-xl font-medium pl-4 md:pl-0 md:mb-0 md:bottom-auto md:left-auto backdrop-blur-md bg-white/90 dark:bg-dark min-w-[200px] max-h-[50vh] overflow-y-auto"
    >
      {
        languageLinks.map(({ targetLang, label, href }) => (
          <li>
            <a
              class:list={[
                'first:rounded-t last:rounded-b md:hover:bg-gray-100 hover:text-link dark:hover:text-white dark:hover:bg-gray-700 py-2 px-5 block whitespace-no-wrap',
                { 'aw-link-active': targetLang === lang },
              ]}
              href={href}
            >
              {label}
            </a>
          </li>
        ))
      }
    </ul>
  </li>
</ul>
