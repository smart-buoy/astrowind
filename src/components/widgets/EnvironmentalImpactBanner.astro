---
import { getLangFromUrl, useTranslations } from '~/i18n/utils';
import { fetchStatistics } from '~/utils/statistics';
import { calculateEnvironmentalImpact } from '~/utils/environmentImpact';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const statistics = await fetchStatistics();
const impact = calculateEnvironmentalImpact(statistics);
const locale = lang === 'de' ? 'de-DE' : 'en-US';

const formatNumber = (value: number, options?: Intl.NumberFormatOptions) =>
  new Intl.NumberFormat(locale, { maximumFractionDigits: 0, ...options }).format(value);

const formatKg = (value: number) =>
  formatNumber(value, { maximumFractionDigits: 1, minimumFractionDigits: value % 1 === 0 ? 0 : 1 });

const formatLiters = (value: number) =>
  formatNumber(value, { maximumFractionDigits: 1, minimumFractionDigits: value % 1 === 0 ? 0 : 1 });

const metrics = [
  {
    id: 'co2',
    value: `${formatKg(impact.co2SavedKg)}`,
    unit: 'kg CO₂',
    description: t('environment-impact.metrics.co2'),
  },
  {
    id: 'fuel',
    value: `${formatLiters(impact.fuelSavedLiters)}`,
    unit: t('environment-impact.metrics.fuel-unit'),
    description: t('environment-impact.metrics.fuel'),
  },
  {
    id: 'seabed',
    value: `${formatNumber(impact.seabedProtectedSqM)}`,
    unit: 'm²',
    description: t('environment-impact.metrics.seabed'),
  },
  {
    id: 'microplastic',
    value: `${formatKg(impact.microplasticAvoidedKg)}`,
    unit: t('environment-impact.metrics.microplastic-unit'),
    description: t('environment-impact.metrics.microplastic'),
  },
];

const replacePlaceholders = (
  text: string,
  replacements: Record<string, number | string>
) =>
  Object.entries(replacements).reduce(
    (acc, [key, value]) => acc.replace(`{${key}}`, String(value)),
    text
  );

const footnote = statistics
  ? replacePlaceholders(t('environment-impact.footnote'), {
      bookings: statistics.numberOfBookings,
      buoys: statistics.numberOfBuoys,
      devices: statistics.numberOfDevices,
    })
  : t('environment-impact.unavailable');
---

<section class="bg-emerald-500 text-emerald-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 py-12 lg:px-8">
    <div class="max-w-2xl">
      <p class="uppercase tracking-wide text-sm font-semibold text-emerald-100">
        {t('environment-impact.tagline')}
      </p>
      <h2 class="mt-3 text-3xl font-bold tracking-tight text-white sm:text-4xl">
        {t('environment-impact.title')}
      </h2>
      <p class="mt-4 text-base leading-7 text-emerald-50">
        {t('environment-impact.subtitle')}
      </p>
    </div>

    <div class="mt-10">
      {
        statistics ? (
          <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-4">
            {metrics.map(({ id, value, unit, description }) => (
              <div
                key={id}
                class="rounded-2xl bg-emerald-600/40 border border-emerald-400/40 px-6 py-6 shadow-sm"
              >
                <div class="text-3xl font-semibold text-white">
                  <span>{value}</span>
                  <span class="ml-1 text-lg font-medium text-emerald-100">{unit}</span>
                </div>
                <p class="mt-3 text-sm text-emerald-100 leading-6">{description}</p>
              </div>
            ))}
          </div>
        ) : (
          <div class="rounded-2xl bg-emerald-600/40 border border-emerald-400/40 px-6 py-6 shadow-sm">
            <p class="text-sm text-emerald-100 leading-6">{footnote}</p>
          </div>
        )
      }
    </div>

    {statistics && (
      <p class="mt-8 text-sm text-emerald-100 leading-6">
        {footnote}
      </p>
    )}
  </div>
</section>
